---
title: "Helios Corn Futures Data Challenge (EDA)"
author: "Timothy Tey"
date: today
date-format: "D MMMM YYYY"
categories: [code, analysis]
toc: true
execute:
    error: false
    freeze: true
---

# Import Libraries
```{python}
import pandas as pd
import numpy as np
import statistics
import math
import missingno as msno

import seaborn as sns
import matplotlib.pyplot as plt

import os
```

# Import Main Dataset
```{python}
raw_data = pd.read_csv('corn_climate_risk_futures_daily_master.csv')
raw_data.head()
```

```{python}
print(raw_data.shape)
print(raw_data.columns)
```

```{python}
hemisphere_data = pd.read_csv('corn_regional_hemisphere.csv')
koppen_data = pd.read_csv('corn_regional_climate_type.csv')

hemisphere_name_dict = dict(zip(hemisphere_data['region_id'], hemisphere_data['hemisphere']))
koppen_name_dict = dict(zip(koppen_data['region_id'], koppen_data['koppen_zone']))

print(hemisphere_name_dict)
print(koppen_name_dict)
```

```{python}
raw_data['hemisphere'] = raw_data['region_id'].map(hemisphere_name_dict)
raw_data['koppen'] = raw_data['region_id'].map(koppen_name_dict)

raw_data.head()
print(raw_data['koppen'].unique())
print(raw_data['hemisphere'].unique())
```

# Categorising dataset(s)
Categorise dataset wrt hemisphere, and then koppen climate type.
```{python}
south_data = raw_data[raw_data['hemisphere'] == 'S']
n1_data = raw_data[raw_data['hemisphere'] == 'N_1']
n2_data = raw_data[raw_data['hemisphere'] == 'N_2']

south_regions_categories = dict()
n1_regions_categories = dict()
n2_regions_categories = dict()

for koppen in raw_data['koppen'].unique():
    south_koppen = south_data[south_data['koppen'] == f'{koppen}']
    south_koppen_region = south_koppen['region_name'].unique().tolist()
    south_regions_categories[koppen] = south_koppen_region

    n1_koppen = n1_data[n1_data['koppen'] == f'{koppen}']
    n1_koppen_region = n1_koppen['region_name'].unique().tolist()
    n1_regions_categories[koppen] = n1_koppen_region

    n2_koppen = n2_data[n2_data['koppen'] == f'{koppen}']
    n2_koppen_region = n2_koppen['region_name'].unique().tolist()
    n2_regions_categories[koppen] = n2_koppen_region

print(south_regions_categories)
print(n1_regions_categories)
print(n2_regions_categories)
```

```{python}
df_cols = raw_data.columns.tolist()
deleted_cols = ['ID', 'crop_name', 'country_code', 'region_id']
df_cols_needed = [col for col in df_cols if col not in deleted_cols]

for koppen, regions in n2_regions_categories.items():
    for i in range(len(regions)):
        specific_region = regions[i]

        filtered_region_df = raw_data[raw_data['region_name'] == specific_region]

        filtered_region_df = filtered_region_df.loc[:, df_cols_needed]
        filtered_region_df["date_on"] = pd.to_datetime(filtered_region_df["date_on"])
        filtered_region_df = filtered_region_df.sort_values(by="date_on", ascending=True)

        #Create categorical variables for harvest period
        mapping_period_dict = {
            'Off-season': 0,
            'Planting': 1,
            'Mid-season': 2,
            'Harvest': 3,
            'Peak Harvest': 4,
        }

        filtered_region_df['categorical_harvest_period'] = filtered_region_df['harvest_period'].map(mapping_period_dict)

        output_dir = f'./North_2_Hemisphere/Region_{koppen}'
        os.makedirs(output_dir, exist_ok=True)

        file_name = f'{specific_region}.csv'
        full_path = os.path.join(output_dir, file_name)
        filtered_region_df.to_csv(full_path, index=False)

print("All dataset are succesfully categorised.")
```

# 1. Nullity Plot(s)
```{python}
# for country, regions in country_region.items():
#     num_regions = len(regions)
#     ncols = 2
#     nrows = math.ceil(num_regions/ncols)

#     fig, axes = plt.subplots(nrows=nrows, ncols=ncols,
#                             figsize=(12, 4 * nrows))
#     fig.suptitle(f"Missing Data Overview: {country}", fontsize=16, fontweight="bold")

#     if num_regions == 1:
#         axes = [axes]
#     else:
#         axes = axes.flatten()

#     for i, region in enumerate(regions):
#         working_df = pd.read_csv(f"./{country}/raw_{region}.csv")

#         msno.matrix(working_df, fontsize=4, label_rotation=45, ax=axes[i], sparkline=False)

#         axes[i].set_title(f"Region: {region}", y=-0.25,fontsize=12)

#     for j in range(i + 1, len(axes)):
#         axes[j].axis('off')
    
#     plt.tight_layout()
#     plt.show()
```